{% extends "base.html" %}
{% block title %}–°—Ç–æ–ø-–∏–≥—Ä–∞ ‚Äî {{ child.name }}{% endblock %}
{% block extra_css %}
<style>
    .gonogo-field {
        width: 320px;
        height: 200px;
        margin: 0 auto 20px;
        border: 3px solid #dee2e6;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        cursor: pointer;
        transition: background 0.2s;
        background: #f5f5f5;
    }
</style>
{% endblock %}
{% block content %}
<div class="container text-center" style="max-width:400px;">
    <h4 class="mb-3">üõë –°—Ç–æ–ø-–∏–≥—Ä–∞</h4>
    <p class="text-muted">–ù–∞–∂–∏–º–∞–π –Ω–∞ <span class="text-success">–∑–µ–ª—ë–Ω—ã–π</span>, –ù–ï –Ω–∞–∂–∏–º–∞–π –Ω–∞ <span class="text-danger">–∫—Ä–∞—Å–Ω—ã–π</span></p>
    <form method="post" id="gameForm">
        {% csrf_token %}
        <input type="hidden" name="session_id" value="{{ session.id }}">
        <input type="hidden" name="data" id="dataInput">
        <div id="targetArea" class="gonogo-field"></div>
        <button type="submit" class="btn btn-success w-100" id="submitBtn" style="display:none;">–ì–æ—Ç–æ–≤–æ!</button>
    </form>
    <a href="{% url 'game_dashboard' child.id %}" class="d-block mt-2">‚Üê –ù–∞–∑–∞–¥</a>
</div>
<script>
let correctGo=0, correctNogo=0, commissionErrors=0, omissionErrors=0, reactionTimes=[], round=0, maxRounds=20, isGo=false, startTime, omissionTimer, nextTimer;
const area = document.getElementById('targetArea');
function next() {
    area.textContent = '';
    area.style.background = '#f5f5f5';
    isGo = Math.random() > 0.3;
    nextTimer = setTimeout(() => {
        if (isGo) {
            area.innerHTML = '<span style="color:green">‚óè</span>';
            area.style.background = '#e8f5e9';
            startTime = Date.now();
            omissionTimer = setTimeout(() => { omissionErrors++; }, 700);
        } else {
            area.innerHTML = '<span style="color:red">‚óè</span>';
            area.style.background = '#ffebee';
        }
        round++;
        if (round >= maxRounds) {
            document.getElementById('submitBtn').style.display = 'block';
            area.textContent = '–ì–æ—Ç–æ–≤–æ!';
            area.onclick = null;
            return;
        }
        nextTimer = setTimeout(next, 1200);
    }, 800 + Math.random()*600);
}
area.onclick = () => {
    if (!area.textContent.includes('‚óè')) return;
    if (isGo) {
        clearTimeout(omissionTimer);
        correctGo++;
        reactionTimes.push(Date.now() - startTime);
    } else {
        commissionErrors++;
        clearTimeout(omissionTimer);
        clearTimeout(nextTimer);
        document.getElementById('submitBtn').style.display = 'block';
        area.textContent = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞';
        area.onclick = null;
        return;
    }
};
next();
document.getElementById('gameForm').onsubmit = () => {
    document.getElementById('dataInput').value = JSON.stringify({
        correct_go: correctGo, correct_nogo: correctNogo,
        commission_errors: commissionErrors, omission_errors: omissionErrors,
        reaction_times: reactionTimes
    });
};
</script>
{% endblock %}
