{% extends "base.html" %}
{% load static %}
{% block title %}–ò–≥—Ä–∞ ¬´–ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞¬ª ‚Äî {{ child.name }}{% endblock %}

{% block extra_css %}
<style>
    .puzzle-game { max-width: 400px; margin: 0 auto; padding: 20px; }
    .puzzle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .puzzle-piece {
        aspect-ratio: 1; background: linear-gradient(135deg, #f093fb, #f5576c);
        border-radius: 12px; display: flex; align-items: center; justify-content: center;
        font-size: 2rem; font-weight: bold; color: white; cursor: pointer;
        transition: transform 0.2s;
    }
    .puzzle-piece:hover { transform: scale(1.05); }
    .puzzle-piece.empty { background: #e0e0e0; cursor: default; }
</style>
{% endblock %}

{% block content %}
<div class="puzzle-game">
    <h4 class="text-center mb-3">üß© –°–æ–±–µ—Ä–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É</h4>
    <p class="text-center text-muted mb-3">–ù–∞–∂–º–∏ –Ω–∞ —á–∏—Å–ª–æ —Ä—è–¥–æ–º —Å –ø—É—Å—Ç—ã–º –º–µ—Å—Ç–æ–º, —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</p>
    <div class="puzzle-grid" id="puzzleGrid"></div>
    <p class="mt-3 text-center" id="moves">–•–æ–¥–æ–≤: 0</p>
    <form method="post" id="puzzleForm" class="mt-3">
        {% csrf_token %}
        <input type="hidden" name="session_id" value="{{ session.id }}">
        <input type="hidden" name="moves" id="movesInput" value="0">
        <input type="hidden" name="completed" id="completed" value="0">
        <button type="submit" class="btn btn-success w-100" id="submitBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
    </form>
    <a href="{% url 'game_dashboard' child.id %}" class="btn btn-outline-secondary mt-2 w-100">–ù–∞–∑–∞–¥</a>
</div>
<script>
let board = [1,2,3,4,5,6,7,8,0];
let moves = 0;
const win = [1,2,3,4,5,6,7,8,0];

function shuffleBoard() {
    const moves = 30 + Math.floor(Math.random() * 40);
    for (let i = 0; i < moves; i++) {
        const empty = board.indexOf(0);
        const neighbors = [[1,3],[0,2,4],[1,5],[0,4,6],[1,3,5,7],[2,4,8],[3,7],[4,6,8],[5,7]];
        const opts = neighbors[empty].filter(n => n !== empty);
        const swap = opts[Math.floor(Math.random() * opts.length)];
        [board[empty], board[swap]] = [board[swap], board[empty]];
    }
}

function render() {
    const grid = document.getElementById('puzzleGrid');
    grid.innerHTML = board.map((n, i) =>
        `<div class="puzzle-piece ${n ? '' : 'empty'}" data-idx="${i}">${n || ''}</div>`
    ).join('');
    grid.querySelectorAll('.puzzle-piece').forEach(p => {
        if (board[p.dataset.idx]) p.onclick = () => move(parseInt(p.dataset.idx));
    });
}

function move(idx) {
    const empty = board.indexOf(0);
    const neighbors = [[1,3],[0,2,4],[1,5],[0,4,6],[1,3,5,7],[2,4,8],[3,7],[4,6,8],[5,7]];
    if (neighbors[empty].includes(idx)) {
        [board[empty], board[idx]] = [board[idx], board[empty]];
        moves++;
        document.getElementById('moves').textContent = '–•–æ–¥–æ–≤: ' + moves;
        document.getElementById('movesInput').value = moves;
        render();
        if (board.every((v,i) => v === win[i])) {
            document.getElementById('completed').value = '1';
            document.getElementById('submitBtn').textContent = '–£—Ä–∞! –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
    }
}

shuffleBoard();
render();
</script>
{% endblock %}
