{% extends "base.html" %}
{% load static %}
{% block title %}–ò–≥—Ä–∞ ¬´–ü–∞–º—è—Ç—å¬ª ‚Äî {{ child.name }}{% endblock %}

{% block extra_css %}
<style>
    .memory-game {
        max-width: 560px;
        margin: 0 auto;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }
    .memory-game h4 { color: white; }
    .memory-game .text-muted { color: rgba(255,255,255,0.9) !important; }
    .memory-grid {
        display: grid;
        gap: 10px;
        margin: 20px 0;
    }
    .memory-card {
        aspect-ratio: 1;
        background: rgba(255,255,255,0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        cursor: pointer;
        color: white;
        transition: all 0.3s;
        border: 2px solid rgba(255,255,255,0.3);
    }
    .memory-card.flipped {
        background: white;
        color: #333;
    }
    .memory-card.matched {
        background: rgba(76, 175, 80, 0.9);
        cursor: default;
        border-color: #4caf50;
    }
    .memory-card:hover:not(.matched):not(.flipped) {
        transform: scale(1.05);
        background: rgba(255,255,255,0.35);
    }
    .level-badge {
        background: rgba(255,255,255,0.3);
        padding: 6px 14px;
        border-radius: 20px;
        color: white;
        font-weight: 600;
    }
    .btn-memory { background: white; color: #764ba2; font-weight: 600; }
    .btn-memory:hover { background: #f0f0f0; color: #764ba2; }
</style>
{% endblock %}

{% block content %}
<div class="memory-game">
    <h4 class="text-center mb-1">üÉè –ù–∞–π–¥–∏ –ø–∞—Ä—ã</h4>
    <p class="text-center text-muted mb-0">–£—Ä–æ–≤–µ–Ω—å <span class="level-badge" id="levelBadge">1</span></p>
    <div class="memory-grid" id="memoryGrid"></div>
    <form method="post" id="memoryForm" class="mt-3">
        {% csrf_token %}
        <input type="hidden" name="session_id" value="{{ session.id }}">
        <input type="hidden" name="pairs_found" id="pairsFound" value="0">
        <input type="hidden" name="attempts" id="attempts" value="0">
        <input type="hidden" name="time_seconds" id="timeSeconds" value="0">
        <input type="hidden" name="levels_completed" id="levelsCompleted" value="0">
        <button type="submit" class="btn btn-memory w-100" id="submitBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–π—Ç–∏</button>
    </form>
    <a href="{% url 'game_dashboard' child.id %}" class="btn btn-outline-light mt-2 w-100">–ù–∞–∑–∞–¥</a>
</div>

<script>
const ALL_EMOJIS = ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','ü¶Å','üêØ','üêÆ','üê∑','üê∏','üêµ'];
const LEVELS = [
    { pairs: 4, cols: 4 },   // 4x2 = 8 –∫–∞—Ä—Ç
    { pairs: 6, cols: 4 },   // 6 –ø–∞—Ä = 12 –∫–∞—Ä—Ç
    { pairs: 8, cols: 4 },   // 8 –ø–∞—Ä = 16 –∫–∞—Ä—Ç
    { pairs: 10, cols: 5 }, // 10 –ø–∞—Ä = 20 –∫–∞—Ä—Ç
];
let level = 0, flipped = [], matched = 0, totalPairsFound = 0, attempts = 0, totalPairs = 0, cards = [];
const startTime = Date.now();

function playSound(type) {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        if (type === 'match') {
            osc.frequency.setValueAtTime(523.25, ctx.currentTime);
            osc.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
        } else if (type === 'wrong') {
            osc.frequency.setValueAtTime(200, ctx.currentTime);
        } else if (type === 'level') {
            osc.frequency.setValueAtTime(392, ctx.currentTime);
            osc.frequency.setValueAtTime(523, ctx.currentTime + 0.1);
            osc.frequency.setValueAtTime(659, ctx.currentTime + 0.2);
        }
        gain.gain.setValueAtTime(0.15, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.25);
    } catch(e) {}
}

function shuffle(a) { for (let i=a.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function initLevel() {
    const config = LEVELS[Math.min(level, LEVELS.length - 1)];
    const shuffled = shuffle([...ALL_EMOJIS]);
    const emojis = shuffled.slice(0, config.pairs);
    cards = shuffle([...emojis, ...emojis]);
    totalPairs = config.pairs;
    flipped = [];
    matched = 0;
    const grid = document.getElementById('memoryGrid');
    grid.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;
    render();
    if (level > 0) playSound('level');
}

function render() {
    const grid = document.getElementById('memoryGrid');
    grid.innerHTML = cards.map((emoji, i) =>
        `<div class="memory-card" data-idx="${i}" data-emoji="${emoji}">?</div>`
    ).join('');
    document.getElementById('levelBadge').textContent = level + 1;
    grid.querySelectorAll('.memory-card').forEach(card => {
        card.onclick = () => {
            if (card.classList.contains('matched') || flipped.length >= 2) return;
            card.classList.add('flipped');
            card.textContent = card.dataset.emoji;
            flipped.push(card);
            if (flipped.length === 2) {
                attempts++;
                document.getElementById('attempts').value = attempts;
                if (flipped[0].dataset.emoji === flipped[1].dataset.emoji) {
                    playSound('match');
                    flipped.forEach(c => { c.classList.add('matched'); });
                    matched++;
                    totalPairsFound++;
                    document.getElementById('pairsFound').value = totalPairsFound;
                    flipped = [];
                    if (matched >= totalPairs) {
                        document.getElementById('levelsCompleted').value = level + 1;
                        if (level < LEVELS.length - 1) {
                            level++;
                            setTimeout(initLevel, 800);
                        } else {
                            playSound('level');
                        }
                    }
                } else {
                    playSound('wrong');
                    setTimeout(() => {
                        flipped.forEach(c => { c.classList.remove('flipped'); c.textContent = '?'; });
                        flipped = [];
                    }, 600);
                }
            }
        };
    });
}

document.getElementById('memoryForm').onsubmit = () => {
    document.getElementById('timeSeconds').value = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('attempts').value = attempts;
    document.getElementById('pairsFound').value = totalPairsFound;
    document.getElementById('levelsCompleted').value = matched >= totalPairs ? level + 1 : level;
};
initLevel();
</script>
{% endblock %}
