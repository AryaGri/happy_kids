{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ–π —Ä–µ–±—ë–Ω–æ–∫ ‚Äî {{ child.name }}{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .child-detail-container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .child-detail-container .container { height: auto !important; justify-content: flex-start !important; }
    .friendly-card { border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
    .friendly-card .card-header { border-radius: 16px 16px 0 0; font-weight: 600; }
    .emotion-emoji { font-size: 1.5rem; }
    .game-badge { border-radius: 12px; padding: 6px 12px; font-size: 0.9rem; }
    .prescription-card { border-left: 4px solid #6f42c1; }
    .recommendation-box { background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); border-radius: 12px; padding: 1rem 1.25rem; }
    .chart-container { position: relative; height: 220px; }
</style>

<div class="child-detail-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-4">
        <a href="{% url 'parent_dashboard' parent.id %}" class="text-decoration-none text-secondary mb-2 d-inline-block">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –º–æ–∏–º –¥–µ—Ç—è–º
        </a>
        <h2 class="mb-1">üëã {{ child.name }}</h2>
        <p class="text-muted mb-0">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {{ child.date_of_b|date:"d.m.Y" }}</p>
    </div>

    <!-- 1. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π (–∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞) -->
    <div class="card friendly-card mb-4">
        <div class="card-header bg-white text-dark py-3">
            <span class="emotion-emoji">üíö</span> –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-5">
                    <div class="chart-container">
                        <canvas id="emotionChart"></canvas>
                    </div>
                </div>
                <div class="col-md-7">
                    <ul class="list-unstyled mb-0">
                        {% for emotion, pct in emotion_percentages.items %}
                        {% if pct > 0 %}
                        <li class="d-flex align-items-center mb-2">
                            {% if emotion == '—Ä–∞–¥–æ—Å—Ç—å' %}<span class="emotion-emoji me-2">üòä</span>
                            {% elif emotion == '–≥—Ä—É—Å—Ç—å' %}<span class="emotion-emoji me-2">üò¢</span>
                            {% elif emotion == '–≥–Ω–µ–≤' %}<span class="emotion-emoji me-2">üò§</span>
                            {% elif emotion == '—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ' %}<span class="emotion-emoji me-2">üòå</span>
                            {% else %}<span class="emotion-emoji me-2">üí≠</span>{% endif %}
                            <span class="flex-grow-1">{{ emotion|capfirst }}</span>
                            <span class="badge rounded-pill bg-light text-dark">{{ pct }}%</span>
                        </li>
                        {% endif %}
                        {% empty %}
                        <li class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü—É—Å—Ç—å —Ä–µ–±—ë–Ω–æ–∫ –ø–æ–∏–≥—Ä–∞–µ—Ç –≤ –∏–≥—Ä—ã!</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä (–±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤) -->
    <div class="card friendly-card mb-4">
        <div class="card-header bg-white text-dark py-3">
            <span class="emotion-emoji">üéÆ</span> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        </div>
        <div class="card-body">
            {% if games_count > 0 %}
            <p class="mb-0">–†–µ–±—ë–Ω–æ–∫ —Å—ã–≥—Ä–∞–ª <strong>{{ games_count }}</strong> {% if games_count == 1 %}–∏–≥—Ä—É{% elif games_count < 5 %}–∏–≥—Ä—ã{% else %}–∏–≥—Ä{% endif %}.</p>
            <p class="text-muted small mb-0 mt-2">–ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É (–≤—Ä–∞—á—É) –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.</p>
            {% else %}
            <p class="text-muted mb-0">–ü–æ–∫–∞ –Ω–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Ä–µ–±—ë–Ω–∫—É –Ω–∞—á–∞—Ç—å!</p>
            {% endif %}
        </div>
    </div>

    <!-- 3. –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤—Ä–∞—á–∞ -->
    <div class="card friendly-card mb-4">
        <div class="card-header bg-white text-dark py-3 d-flex justify-content-between align-items-center">
            <span><span class="emotion-emoji">üìã</span> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</span>
            {% if prescriptions %}
            <a href="{% url 'parent_download_prescriptions' child.id %}" class="btn btn-sm btn-outline-primary" title="–°–∫–∞—á–∞—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è">
                <i class="fas fa-download me-1"></i>–°–∫–∞—á–∞—Ç—å
            </a>
            {% endif %}
        </div>
        <div class="card-body">
            {% if prescriptions %}
            <div class="d-flex flex-column gap-3">
                {% for prescription in prescriptions %}
                <div class="prescription-card card bg-light">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="badge 
                                {% if prescription.prescription_type == 'medication' %}bg-primary
                                {% elif prescription.prescription_type == 'therapy' %}bg-info
                                {% elif prescription.prescription_type == 'exercise' %}bg-success
                                {% else %}bg-secondary{% endif %}">
                                {% if prescription.prescription_type == 'medication' %}üíä –õ–µ–∫–∞—Ä—Å—Ç–≤–æ
                                {% elif prescription.prescription_type == 'therapy' %}üßò –ó–∞–Ω—è—Ç–∏—è
                                {% elif prescription.prescription_type == 'exercise' %}üèÉ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                                {% else %}üìå –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è{% endif %}
                            </span>
                            <small class="text-muted">{{ prescription.date_created|date:"d.m.Y" }}</small>
                        </div>
                        <p class="mb-0">{{ prescription.text }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π. –í—Ä–∞—á –¥–æ–±–∞–≤–∏—Ç –∏—Ö –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</p>
            {% endif %}
        </div>
    </div>

    <!-- 4. –°–æ–≤–µ—Ç—ã –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è -->
    <div class="card friendly-card mb-4">
        <div class="card-header bg-white text-dark py-3">
            <span class="emotion-emoji">üí°</span> –°–æ–≤–µ—Ç—ã –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è
        </div>
        <div class="card-body">
            {% if profile and profile.recommendations %}
            <div class="recommendation-box">
                {{ profile.recommendations|linebreaks }}
            </div>
            {% else %}
            <p class="text-muted mb-0">–°–æ–≤–µ—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ä–µ–±—ë–Ω–æ–∫ –ø–æ–∏–≥—Ä–∞–µ—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–≥—Ä.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const emotionData = {{ emotion_percentages_json|safe }};
    const labels = [];
    const data = [];
    const bgColors = [];
    const colors = {
        '—Ä–∞–¥–æ—Å—Ç—å': 'rgba(76, 175, 80, 0.85)',
        '–≥—Ä—É—Å—Ç—å': 'rgba(33, 150, 243, 0.85)',
        '–≥–Ω–µ–≤': 'rgba(244, 67, 54, 0.85)',
        '—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ': 'rgba(156, 39, 176, 0.85)'
    };
    const order = ['—Ä–∞–¥–æ—Å—Ç—å', '—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ', '–≥—Ä—É—Å—Ç—å', '–≥–Ω–µ–≤'];
    
    for (const key of order) {
        if (emotionData[key] !== undefined && emotionData[key] > 0) {
            labels.push(key.charAt(0).toUpperCase() + key.slice(1));
            data.push(emotionData[key]);
            bgColors.push(colors[key] || 'rgba(158, 158, 158, 0.85)');
        }
    }
    
    if (data.length > 0) {
        const ctx = document.getElementById('emotionChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: bgColors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                cutout: '60%'
            }
        });
    }
});
</script>
{% endblock %}
