{% extends 'base.html' %}

{% block content %}
<div class="container7">

  <form class='form1' method="POST" enctype="multipart/form-data">
      <h2>Редактировать врача: {{ doctor.username }}</h2>

      {% csrf_token %}
    <div class="form-group">
      <label for="username">Логин:</label>
      <input type="text" name="username" id="username" class="form-control" value="{{ doctor.username }}" required>
    </div>

    <div class="form-group">
      <label for="name">ФИО:</label>
      <input type="text" name="name" id="name" class="form-control" value="{{ doctor.name }}" required>
    </div>

    <div class="form-group">
      <label for="date_of_b">Дата рождения:</label>
      <input type="date" name="date_of_b" id="date_of_b" class="form-control" value="{{ doctor.date_of_b|date:'Y-m-d' }}" required>
    </div>

    <div class="form-group">
      <label for="password">Пароль:</label>
      <input type="text" name="password" id="password" class="form-control" value="{{ doctor.password }}" required>
    </div>

    <div class="form-group">
      <label for="role">Роль:</label>
      <select name="role" id="role" class="form-control" required>
        <option value="doctor" selected>Врач</option>
        <option value="parent" {% if doctor.role == 'parent' %}selected{% endif %}>Родитель</option>
        <option value="child" {% if doctor.role == 'child' %}selected{% endif %}>Ребёнок</option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
    </form>

    <hr class="my-4">
    <h4>Пациенты врача</h4>
    <p class="text-muted small">Привяжите детей (пациентов) к этому врачу</p>
    <form method="POST" class="mt-2">
      {% csrf_token %}
      <input type="hidden" name="assign_patient" value="1">
      <div class="form-group mb-2">
        <label for="patient_id" class="form-label">Добавить пациента:</label>
        <select name="patient_id" id="patient_id" class="form-control">
          <option value="">Выберите ребёнка</option>
          {% for child in available_patients %}
          <option value="{{ child.id }}">{{ child.name }} ({{ child.date_of_b|date:"d.m.Y" }})</option>
          {% endfor %}
        </select>
        {% if not available_patients %}
        <small class="text-muted">Все дети уже привязаны к этому врачу</small>
        {% endif %}
      </div>
      <button type="submit" class="btn btn-outline-primary" {% if not available_patients %}disabled{% endif %}>Добавить пациента</button>
    </form>
    <ul class="list-group mt-3">
      {% for patient in assigned_patients %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ patient.name }} ({{ patient.date_of_b|date:"d.m.Y" }})
        <form method="POST" class="d-inline" onsubmit="return confirm('Отвязать пациента?');">
          {% csrf_token %}
          <input type="hidden" name="remove_patient" value="{{ patient.id }}">
          <button type="submit" class="btn btn-sm btn-outline-danger">Отвязать</button>
        </form>
      </li>
      {% empty %}
      <li class="list-group-item text-muted">Нет привязанных пациентов</li>
      {% endfor %}
    </ul>

  <br>
  <div class="mt-3">
      <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">Назад к дашборду</a>
      <a href="{% url 'admin_delete_user' doctor.id %}" class="btn btn-outline-danger ms-2">Удалить пользователя</a>
  </div>
</div>
{% endblock %}
