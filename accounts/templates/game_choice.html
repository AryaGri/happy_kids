{% extends "base.html" %}
{% load static %}
{% block title %}–°–æ–±–µ—Ä–∏ –∫–æ–º–∏–∫—Å ‚Äî {{ child.name }}{% endblock %}

{% block extra_css %}
<style>
    .comic-game { max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 24px; padding: 28px; box-shadow: 0 12px 40px rgba(0,0,0,0.1); }
    .comic-card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .comic-scene { font-size: 2.5rem; text-align: center; margin-bottom: 8px; }
    .comic-text { font-size: 1rem; color: #555; text-align: center; margin-bottom: 12px; line-height: 1.4; }
    .comic-options { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
    .comic-option { min-width: 100px; padding: 12px 16px; border-radius: 16px; background: #f5f5f5; border: 3px solid #e0e0e0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.8rem; cursor: pointer; transition: all 0.25s; }
    .comic-option span { font-size: 0.75rem; color: #666; margin-top: 4px; text-align: center; }
    .comic-option:hover { background: #fff3e0; border-color: #ff9800; transform: scale(1.08); }
    .comic-option.selected { background: linear-gradient(135deg, #ff9800, #f57c00); border-color: #e65100; }
    .progress-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
    .progress-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(0,0,0,0.2); }
    .progress-dot.done { background: #4caf50; }
    .progress-dot.current { background: #ff9800; transform: scale(1.3); }
    .btn-submit { background: linear-gradient(135deg, #4caf50, #388e3c); color: white !important; border: none; padding: 16px; border-radius: 16px; font-size: 1.1rem; font-weight: 600; width: 100%; }
</style>
{% endblock %}

{% block content %}
<div class="comic-game">
    <h4 class="text-center mb-2" style="color:#7b1fa2;">üìñ –û–¥–∏–Ω –¥–µ–Ω—å</h4>
    <p class="text-center text-muted mb-4">–°–æ–±–µ—Ä–∏ –∏—Å—Ç–æ—Ä–∏—é: –≤—ã–±–µ—Ä–∏, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –¥–∞–ª—å—à–µ</p>

    <div class="progress-dots" id="progressDots"></div>

    <form method="post" id="choiceForm">
        {% csrf_token %}
        <input type="hidden" name="session_id" value="{{ session.id }}">
        <div id="comicContent"></div>
        <div class="d-flex gap-2 mt-3">
            <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="display:none;">‚Üê –ù–∞–∑–∞–¥</button>
            <button type="button" class="btn btn-primary flex-grow-1" id="nextBtn">–î–∞–ª—å—à–µ ‚Üí</button>
        </div>
        <button type="submit" class="btn btn-submit mt-3" id="submitBtn" style="display:none;">–ì–æ—Ç–æ–≤–æ!</button>
    </form>

    <div class="text-center mt-3">
        <a href="{% url 'game_dashboard' child.id %}" id="backToDashboard" class="text-dark">‚Üê –ù–∞–∑–∞–¥ –∫ –∏–≥—Ä–∞–º</a>
    </div>
</div>

<script>
const SCENARIOS = [
[
    { text: "–£—Ç—Ä–æ. –ö–æ—Ç—ë–Ω–æ–∫ –ø—Ä–æ—Å–Ω—É–ª—Å—è –≤ —Å–≤–æ–µ–π –∫–æ—Ä–∑–∏–Ω–∫–µ.", scene: "üê± ‚òÄÔ∏è", opts: [
        { e: "üòä", t: "–ü–æ—Ç—è–Ω—É–ª—Å—è –∏ —É–ª—ã–±–Ω—É–ª—Å—è", v: "joy" },
        { e: "üèÉ", t: "–í—Å–∫–æ—á–∏–ª –∏ –ø–æ–±–µ–∂–∞–ª", v: "happiness" },
        { e: "üò¥", t: "–ó–∞–∫—Ä—ã–ª –≥–ª–∞–∑–∞ —Å–Ω–æ–≤–∞", v: "boredom" },
        { e: "üòê", t: "–ù–µ—Ö–æ—Ç—è –ø–æ–¥–Ω—è–ª—Å—è", v: "sorrow" }
    ]},
    { text: "–ü–æ–∑–∞–≤—Ç—Ä–∞–∫–∞–ª –º–æ–ª–æ—á–∫–æ–º. –ö–æ—Ç—ë–Ω–æ–∫...", scene: "üê± ü•õ", opts: [
        { e: "ü´∞", t: "–ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏–ª –∏ —É—à—ë–ª", v: "love" },
        { e: "üêæ", t: "–ü–æ—Ç—Ä–æ–≥–∞–ª –ª–∞–ø–∫–æ–π –º–∏—Å–∫—É", v: "joy" },
        { e: "üéæ", t: "–ü–æ–±–µ–∂–∞–ª –∏–≥—Ä–∞—Ç—å —Å –º—è—á–∏–∫–æ–º", v: "happiness" },
        { e: "ü™ü", t: "–ü–æ–¥–æ—à—ë–ª –∫ –æ–∫–Ω—É", v: "boredom" }
    ]},
    { text: "–î–Ω—ë–º –≤—ã—à–µ–ª –≤–æ –¥–≤–æ—Ä. –¢–∞–º —Å–∏–¥–µ–ª –¥—Ä—É–≥–æ–π –∫–æ—Ç—ë–Ω–æ–∫.", scene: "üê± üê±", opts: [
        { e: "ü§ó", t: "–ü–æ–¥–±–µ–∂–∞–ª –∏ –æ–±–Ω—è–ª", v: "love" },
        { e: "üëã", t: "–ü–æ–º–∞—Ö–∞–ª –ª–∞–ø–∫–æ–π", v: "joy" },
        { e: "üèÉ", t: "–ü–æ–±–µ–∂–∞–ª –∏–≥—Ä–∞—Ç—å –≤–º–µ—Å—Ç–µ", v: "happiness" },
        { e: "üòê", t: "–ü—Ä–æ—à—ë–ª –º–∏–º–æ", v: "boredom" }
    ]},
    { text: "–ò–≥—Ä–∞–ª–∏ –≤ –¥–æ–≥–æ–Ω—è–ª–∫–∏. –ü–æ—Ç–æ–º –¥—Ä—É–≥ —É—à—ë–ª –¥–æ–º–æ–π.", scene: "üê± üëã", opts: [
        { e: "üëã", t: "–ü–æ–º–∞—Ö–∞–ª –Ω–∞ –ø—Ä–æ—â–∞–Ω–∏–µ", v: "love" },
        { e: "üòî", t: "–ü—Ä–∏–≥–æ—Ä—é–Ω–∏–ª—Å—è", v: "sorrow" },
        { e: "üéÆ", t: "–ü–æ–±–µ–∂–∞–ª –∏–≥—Ä–∞—Ç—å –¥–∞–ª—å—à–µ", v: "happiness" },
        { e: "ü•±", t: "–ó–µ–≤–Ω—É–ª –∏ –ø–æ—à—ë–ª –¥–æ–º–æ–π", v: "boredom" }
    ]},
    { text: "–í–µ—á–µ—Ä. –ö–æ—Ç—ë–Ω–æ–∫ –¥–æ–º–∞. –î–µ–Ω—å –∑–∞–∫–æ–Ω—á–∏–ª—Å—è.", scene: "üê± üåô", opts: [
        { e: "üõãÔ∏è", t: "–£—é—Ç–Ω–æ —Å–≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞ –¥–∏–≤–∞–Ω–µ", v: "love" },
        { e: "üåô", t: "–°–º–æ—Ç—Ä–∏—Ç –≤ –æ–∫–Ω–æ –Ω–∞ –ª—É–Ω—É", v: "sorrow" },
        { e: "üòä", t: "–î–æ–≤–æ–ª–µ–Ω, —á—Ç–æ –±—ã–ª —Ö–æ—Ä–æ—à–∏–π –¥–µ–Ω—å", v: "joy" },
        { e: "üìñ", t: "–°–ª—É—à–∞–µ—Ç —Å–∫–∞–∑–∫—É –ø–µ—Ä–µ–¥ —Å–Ω–æ–º", v: "happiness" }
    ]},
],
[
    { text: "–£—Ç—Ä–æ. –ó–∞–π—á–∏–∫ –ø—Ä–æ—Å–Ω—É–ª—Å—è –≤ —Å–≤–æ–µ–π –Ω–æ—Ä–∫–µ.", scene: "üê∞ ‚òÄÔ∏è", opts: [
        { e: "üòä", t: "–ü–æ—Ç—è–Ω—É–ª—Å—è –∏ —É–ª—ã–±–Ω—É–ª—Å—è", v: "joy" },
        { e: "ü•ï", t: "–ü–æ–¥—É–º–∞–ª –ø—Ä–æ –∑–∞–≤—Ç—Ä–∞–∫", v: "happiness" },
        { e: "üò¥", t: "–ï—â—ë –ø—è—Ç—å –º–∏–Ω—É—Ç–æ—á–µ–∫...", v: "boredom" },
        { e: "ü™ü", t: "–ü–æ—Å–º–æ—Ç—Ä–µ–ª –Ω–∞ —Å–æ–ª–Ω—Ü–µ", v: "sorrow" }
    ]},
    { text: "–ü–æ–∑–∞–≤—Ç—Ä–∞–∫–∞–ª –º–æ—Ä–∫–æ–≤–∫–æ–π. –ó–∞–π—á–∏–∫...", scene: "üê∞ ü•ï", opts: [
        { e: "üëç", t: "–ë—ã–ª–æ –≤–∫—É—Å–Ω–æ!", v: "joy" },
        { e: "üèÉ", t: "–ü–æ–±–µ–∂–∞–ª –≤ —Å–∞–¥", v: "happiness" },
        { e: "üêá", t: "–ü–æ–∑–≤–∞–ª –¥—Ä—É–≥–∞", v: "love" },
        { e: "üòê", t: "–°–∏–¥–µ–ª –∏ –¥—É–º–∞–ª", v: "boredom" }
    ]},
    { text: "–í —Å–∞–¥—É –∑–∞–π—á–∏–∫ –≤—Å—Ç—Ä–µ—Ç–∏–ª —ë–∂–∏–∫–∞.", scene: "üê∞ ü¶î", opts: [
        { e: "ü§ó", t: "–û–±—Ä–∞–¥–æ–≤–∞–ª—Å—è –∏ –æ–±–Ω—è–ª", v: "love" },
        { e: "üçé", t: "–£–≥–æ—Å—Ç–∏–ª —è–±–ª–æ–∫–æ–º", v: "joy" },
        { e: "üèÉ", t: "–ü—Ä–µ–¥–ª–æ–∂–∏–ª –ø–æ–±–µ–≥–∞—Ç—å", v: "happiness" },
        { e: "üëã", t: "–ü–æ–º–∞—Ö–∞–ª –∏ –ø–æ—à—ë–ª –¥–∞–ª—å—à–µ", v: "boredom" }
    ]},
    { text: "–ò–≥—Ä–∞–ª–∏ –≤ –ø—Ä—è—Ç–∫–∏. –Å–∂–∏–∫ —Å–ø—Ä—è—Ç–∞–ª—Å—è –∏ –Ω–µ –≤—ã—à–µ–ª.", scene: "üê∞ ü§î", opts: [
        { e: "üòÑ", t: "–ò—Å–∫–∞–ª –∏ —Å–º–µ—è–ª—Å—è", v: "joy" },
        { e: "üòî", t: "–ó–∞–≥—Ä—É—Å—Ç–∏–ª", v: "sorrow" },
        { e: "üîç", t: "–ü—Ä–æ–¥–æ–ª–∂–∏–ª –∏—Å–∫–∞—Ç—å", v: "happiness" },
        { e: "üè†", t: "–ü–æ—à—ë–ª –¥–æ–º–æ–π", v: "boredom" }
    ]},
    { text: "–í–µ—á–µ—Ä. –ó–∞–π—á–∏–∫ –≤–µ—Ä–Ω—É–ª—Å—è –≤ –Ω–æ—Ä–∫—É.", scene: "üê∞ üåô", opts: [
        { e: "üõèÔ∏è", t: "–£–ª—ë–≥—Å—è –≤ –∫—Ä–æ–≤–∞—Ç–∫—É", v: "love" },
        { e: "üòä", t: "–í—Å–ø–æ–º–∏–Ω–∞–ª –≤–µ—Å—ë–ª—ã–π –¥–µ–Ω—å", v: "joy" },
        { e: "üìñ", t: "–í–∑—è–ª –∫–Ω–∏–∂–∫—É", v: "happiness" },
        { e: "üåô", t: "–°–º–æ—Ç—Ä–µ–ª –Ω–∞ –∑–≤—ë–∑–¥—ã", v: "sorrow" }
    ]},
],
[
    { text: "–£—Ç—Ä–æ. –©–µ–Ω–æ–∫ –ø—Ä–æ—Å–Ω—É–ª—Å—è –≤ –±—É–¥–∫–µ.", scene: "üê∂ ‚òÄÔ∏è", opts: [
        { e: "üêï", t: "–í—Å—Ç—Ä—è—Ö–Ω—É–ª—Å—è –∏ –ø–æ–±–µ–∂–∞–ª", v: "happiness" },
        { e: "üòä", t: "–í–∏–ª—è–ª —Ö–≤–æ—Å—Ç–æ–º", v: "joy" },
        { e: "üò¥", t: "–ó–µ–≤–Ω—É–ª –∏ –ø–æ—Ç—è–Ω—É–ª—Å—è", v: "boredom" },
        { e: "ü™µ", t: "–ü–æ–≥—Ä—ã–∑ –ø–∞–ª–∫—É", v: "sorrow" }
    ]},
    { text: "–•–æ–∑—è–∏–Ω –¥–∞–ª –∑–∞–≤—Ç—Ä–∞–∫. –©–µ–Ω–æ–∫...", scene: "üê∂ üçñ", opts: [
        { e: "ü´∞", t: "–ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏–ª", v: "love" },
        { e: "üòã", t: "–°—ä–µ–ª —Å –∞–ø–ø–µ—Ç–∏—Ç–æ–º", v: "joy" },
        { e: "üéæ", t: "–ü–æ–ø—Ä–æ—Å–∏–ª –º—è—á–∏–∫", v: "happiness" },
        { e: "üòê", t: "–ü–æ–µ–ª –∏ –ª—ë–≥", v: "boredom" }
    ]},
    { text: "–ù–∞ –ø—Ä–æ–≥—É–ª–∫–µ —â–µ–Ω–æ–∫ —É–≤–∏–¥–µ–ª –∫–æ—à–∫—É.", scene: "üê∂ üê±", opts: [
        { e: "ü§ù", t: "–ü–æ–¥–æ—à—ë–ª –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è", v: "love" },
        { e: "üèÉ", t: "–ü–æ–±–µ–∂–∞–ª –∏–≥—Ä–∞—Ç—å", v: "joy" },
        { e: "üò§", t: "–ó–∞–ª–µ—Ç–µ–ª", v: "anger" },
        { e: "üö∂", t: "–ü—Ä–æ—à—ë–ª –º–∏–º–æ", v: "boredom" }
    ]},
    { text: "–ö–æ—à–∫–∞ —É–±–µ–∂–∞–ª–∞ –Ω–∞ –¥–µ—Ä–µ–≤–æ. –©–µ–Ω–æ–∫...", scene: "üê∂ üå≥", opts: [
        { e: "üòî", t: "–û–±–∏–¥–µ–ª—Å—è", v: "sorrow" },
        { e: "üêï", t: "–ü–æ–º–∞—Ö–∞–ª —Ö–≤–æ—Å—Ç–æ–º –∏ —É—à—ë–ª", v: "joy" },
        { e: "üèÉ", t: "–ü–æ–±–µ–∂–∞–ª –∫ —Ö–æ–∑—è–∏–Ω—É", v: "happiness" },
        { e: "ü™µ", t: "–ù–∞—à—ë–ª –ø–∞–ª–∫—É", v: "boredom" }
    ]},
    { text: "–í–µ—á–µ—Ä. –©–µ–Ω–æ–∫ –¥–æ–º–∞. –î–µ–Ω—å –±—ã–ª –¥–æ–ª–≥–∏–π.", scene: "üê∂ üåô", opts: [
        { e: "üõãÔ∏è", t: "–£–ª—ë–≥—Å—è —É –Ω–æ–≥ —Ö–æ–∑—è–∏–Ω–∞", v: "love" },
        { e: "üòä", t: "–î–æ–≤–æ–ª–µ–Ω –ø—Ä–æ–≥—É–ª–∫–æ–π", v: "joy" },
        { e: "üò¥", t: "–ó–∞—Å—ã–ø–∞–µ—Ç", v: "happiness" },
        { e: "ü™µ", t: "–ì—Ä—ã–∑—ë—Ç –ª—é–±–∏–º—É—é –ø–∞–ª–∫—É", v: "boredom" }
    ]},
],
];
function shuffle(arr) { for (let i=arr.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
let ROUNDS = SCENARIOS[Math.floor(Math.random() * SCENARIOS.length)];
let current = 0;
const total = 5;
let reactionTimes = [];
let choices = {};

for (let i = 0; i < total; i++) {
    document.getElementById('progressDots').innerHTML += `<span class="progress-dot" id="dot${i+1}"></span>`;
}

function showRound(n) {
    const r = ROUNDS[n];
    const order = shuffle([0,1,2,3]);
    const optsHtml = order.map(i => {
        const o = r.opts[i];
        return `<label class="comic-option"><input type="radio" name="round_${n+1}" value="${o.v}" data-text="${o.t.replace(/"/g, '&quot;')}" style="display:none">${o.e}<span>${o.t}</span></label>`;
    }).join('');
    document.getElementById('comicContent').innerHTML = `
        <div class="comic-card">
            <p class="comic-text">${r.text}</p>
            <div class="comic-scene">${r.scene}</div>
            <p class="comic-text mb-3">–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –¥–∞–ª—å—à–µ?</p>
            <div class="comic-options">${optsHtml}</div>
        </div>
    `;

    document.getElementById('nextBtn').disabled = true;
    document.getElementById('submitBtn').disabled = true;
    const prevChoice = choices['round_' + (n+1)];
    const prevVal = prevChoice && (typeof prevChoice === 'object' ? prevChoice.value : prevChoice);
    document.querySelectorAll('.comic-option').forEach(opt => {
        const inp = opt.querySelector('input');
        if (prevVal && prevVal === inp.value) {
            opt.classList.add('selected');
            inp.checked = true;
            document.getElementById('nextBtn').disabled = false;
            if (n === total - 1) document.getElementById('submitBtn').disabled = false;
        }
        opt.onclick = function() {
            document.querySelectorAll('.comic-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            const inp = this.querySelector('input');
            inp.checked = true;
            const question = r.text + (r.scene ? ' ' + r.scene : '') + ' –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –¥–∞–ª—å—à–µ?';
            choices['round_' + (n+1)] = { question: question, selected: inp.dataset.text || this.querySelector('span').textContent, value: inp.value };
            document.getElementById('nextBtn').disabled = false;
            if (n === total - 1) document.getElementById('submitBtn').disabled = false;
        };
    });

    document.querySelectorAll('.progress-dot').forEach((d, i) => {
        d.classList.remove('done', 'current');
        if (i < n) d.classList.add('done');
        if (i === n) d.classList.add('current');
    });
    document.getElementById('prevBtn').style.display = n > 0 ? 'block' : 'none';
    document.getElementById('nextBtn').style.display = n < total - 1 ? 'block' : 'none';
    document.getElementById('submitBtn').style.display = n === total - 1 ? 'block' : 'none';
    document.getElementById('submitBtn').disabled = true;
    if (n === total - 1 && choices['round_5']) document.getElementById('submitBtn').disabled = false;
}

document.getElementById('nextBtn').onclick = () => {
    current++;
    showRound(current);
};
document.getElementById('prevBtn').onclick = () => { current--; showRound(current); };

function prepareChoiceForm() {
    let choicesInp = document.querySelector('input[name="choices_json"]');
    if (!choicesInp) {
        choicesInp = document.createElement('input');
        choicesInp.type = 'hidden';
        choicesInp.name = 'choices_json';
        document.getElementById('choiceForm').appendChild(choicesInp);
    }
    choicesInp.value = JSON.stringify(choices);
    let rt = document.querySelector('input[name="reaction_times"]');
    if (!rt) {
        rt = document.createElement('input');
        rt.type = 'hidden';
        rt.name = 'reaction_times';
        document.getElementById('choiceForm').appendChild(rt);
    }
    rt.value = JSON.stringify(reactionTimes);
}

document.getElementById('choiceForm').onsubmit = () => { prepareChoiceForm(); };

document.getElementById('backToDashboard').addEventListener('click', function(e) {
    e.preventDefault();
    prepareChoiceForm();
    document.getElementById('choiceForm').submit();
});

showRound(0);
</script>
{% endblock %}
