{% extends "base.html" %}
{% block title %}–í—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Äî {{ child.name }}{% endblock %}
{% block content %}
<div class="container" style="max-width:560px;">
    <h4 class="text-center mb-3">üñºÔ∏è –í—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É</h4>
    <p class="text-center text-muted mb-4">–ö–∞–∫–∞—è —Ç–µ–±–µ –±–æ–ª—å—à–µ –Ω—Ä–∞–≤–∏—Ç—Å—è?</p>
    <form method="post" id="gameForm">
        {% csrf_token %}
        <input type="hidden" name="session_id" value="{{ session.id }}">
        <input type="hidden" name="data" id="dataInput">
        <div class="card p-4 mb-3">
            <p class="text-center mb-3" id="promptText"></p>
            <div class="d-flex flex-wrap gap-3 justify-content-center" id="options"></div>
        </div>
        <div class="d-flex gap-2 justify-content-between">
            <button type="button" class="btn btn-outline-secondary" id="backBtn" style="display:none;">‚Üê –ù–∞–∑–∞–¥</button>
            <button type="button" class="btn btn-primary" id="nextBtn" style="display:none;">–î–∞–ª—å—à–µ ‚Üí</button>
        </div>
        <button type="submit" class="btn btn-success w-100 mt-3" id="submitBtn" style="display:none;" disabled>–ì–æ—Ç–æ–≤–æ!</button>
    </form>
    <a href="{% url 'game_dashboard' child.id %}" id="backToDashboard" class="d-block text-center mt-2">‚Üê –ù–∞–∑–∞–¥</a>
</div>
<script>
const ROUNDS = [
    { text: "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è?", opts: [
        { e: "‚òÄÔ∏è", t: "–°–æ–ª–Ω–µ—á–Ω–æ", v: "joy" },
        { e: "‚õÖ", t: "–û–±–ª–∞—á–Ω–æ", v: "boredom" },
        { e: "üåßÔ∏è", t: "–î–æ–∂–¥—å", v: "sorrow" },
        { e: "üåà", t: "–†–∞–¥—É–≥–∞", v: "happiness" }
    ]},
    { text: "–ß–µ–º –±—ã —Ç—ã —Ö–æ—Ç–µ–ª –∑–∞–Ω—è—Ç—å—Å—è?", opts: [
        { e: "‚öΩ", t: "–ü–æ–∏–≥—Ä–∞—Ç—å", v: "joy" },
        { e: "üìñ", t: "–ü–æ—á–∏—Ç–∞—Ç—å", v: "love" },
        { e: "üé®", t: "–ü–æ—Ä–∏—Å–æ–≤–∞—Ç—å", v: "happiness" },
        { e: "üõãÔ∏è", t: "–û—Ç–¥–æ—Ö–Ω—É—Ç—å", v: "boredom" }
    ]},
    { text: "–ö–∞–∫–æ–µ –º–µ—Å—Ç–æ —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è?", opts: [
        { e: "üè†", t: "–î–æ–º–∞", v: "love" },
        { e: "üèûÔ∏è", t: "–í –ø–∞—Ä–∫–µ", v: "joy" },
        { e: "üåä", t: "–£ –≤–æ–¥—ã", v: "sorrow" },
        { e: "üé™", t: "–ù–∞ –ø—Ä–∞–∑–¥–Ω–∏–∫–µ", v: "happiness" }
    ]},
    { text: "–ö–∞–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂ —Ç–µ–±–µ —Å–∏–º–ø–∞—Ç–∏—á–µ–Ω?", opts: [
        { e: "üê±", t: "–ö–æ—Ç–∏–∫", v: "love" },
        { e: "üê∂", t: "–°–æ–±–∞—á–∫–∞", v: "joy" },
        { e: "üê∞", t: "–ó–∞–π—á–∏–∫", v: "happiness" },
        { e: "ü¶ä", t: "–õ–∏—Å–∏—á–∫–∞", v: "boredom" }
    ]},
    { text: "–ß—Ç–æ –±—ã —Ç—ã –≤—ã–±—Ä–∞–ª –Ω–∞ —É–∂–∏–Ω?", opts: [
        { e: "üçï", t: "–ü–∏—Ü—Ü—É", v: "joy" },
        { e: "üç≤", t: "–°—É–ø", v: "love" },
        { e: "üç∞", t: "–¢–æ—Ä—Ç", v: "happiness" },
        { e: "ü•ó", t: "–°–∞–ª–∞—Ç", v: "boredom" }
    ]},
    { text: "–ö–∞–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?", opts: [
        { e: "üòä", t: "–£–ª—ã–±–∫–∞", v: "joy" },
        { e: "ü§ó", t: "–û–±—ä—è—Ç–∏–µ", v: "love" },
        { e: "üåô", t: "–õ—É–Ω–∞", v: "sorrow" },
        { e: "‚≠ê", t: "–ó–≤–µ–∑–¥–∞", v: "happiness" }
    ]},
];
let idx = 0, reactionTimes = [], choices = {};

function shuffle(arr) { for (let i=arr.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

function show() {
    const r = ROUNDS[idx];
    const order = shuffle([0,1,2,3]);
    const prevChoice = choices['round_' + (idx+1)];
    const selectedVal = typeof prevChoice === 'object' ? prevChoice?.value : prevChoice;
    const optsHtml = order.map(i => {
        const o = r.opts[i];
        const active = selectedVal === o.v ? ' btn-primary' : ' btn-outline-primary';
        return `<button type="button" class="btn btn-lg p-3${active}" data-val="${o.v}" data-text="${(o.t||'').replace(/"/g,'&quot;')}" style="min-width:100px;font-size:2rem">${o.e}<br><small class="d-block mt-1">${o.t}</small></button>`;
    }).join('');
    document.getElementById('promptText').textContent = r.text;
    document.getElementById('options').innerHTML = optsHtml;
    document.getElementById('backBtn').style.display = idx > 0 ? 'inline-block' : 'none';
    document.getElementById('nextBtn').style.display = idx < ROUNDS.length - 1 ? 'inline-block' : 'none';
    document.getElementById('submitBtn').style.display = idx === ROUNDS.length - 1 ? 'block' : 'none';
    document.getElementById('nextBtn').disabled = !choices['round_' + (idx+1)];

    const start = Date.now();
    document.getElementById('options').querySelectorAll('button').forEach(btn => {
        btn.onclick = () => {
            reactionTimes[idx] = Date.now() - start;
            choices['round_' + (idx+1)] = { question: r.text, selected: btn.dataset.text || btn.querySelector('small')?.textContent || '', value: btn.dataset.val };
            document.querySelectorAll('#options button').forEach(b => { b.classList.remove('btn-primary'); b.classList.add('btn-outline-primary'); });
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-primary');
            document.getElementById('nextBtn').disabled = false;
            if (idx === ROUNDS.length - 1) document.getElementById('submitBtn').disabled = false;
        };
    });
    if (idx === ROUNDS.length - 1 && choices['round_' + (idx+1)]) {
        document.getElementById('submitBtn').disabled = false;
    }
}

document.getElementById('nextBtn').onclick = () => {
    idx++;
    show();
};

document.getElementById('backBtn').onclick = () => {
    idx--;
    show();
};

function prepareEmotionMatchForm() {
    document.getElementById('dataInput').value = JSON.stringify({
        correct: Object.keys(choices).length,
        total: ROUNDS.length,
        choices: choices,
        reaction_times: reactionTimes
    });
}

document.getElementById('gameForm').onsubmit = () => { prepareEmotionMatchForm(); };

document.getElementById('backToDashboard').addEventListener('click', function(e) {
    e.preventDefault();
    prepareEmotionMatchForm();
    document.getElementById('gameForm').submit();
});

show();
</script>
{% endblock %}
