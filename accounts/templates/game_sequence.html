{% extends "base.html" %}
{% load static %}
{% block title %}–ò–≥—Ä–∞ ¬´–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å¬ª ‚Äî {{ child.name }}{% endblock %}

{% block extra_css %}
<style>
    .sequence-game { max-width: 400px; margin: 0 auto; padding: 20px; }
    .seq-buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
    .seq-btn {
        width: 70px; height: 70px; border-radius: 50%; border: 4px solid #333;
        font-size: 1.5rem; cursor: pointer; transition: all 0.2s;
    }
    .seq-btn.red { background: #e74c3c; }
    .seq-btn.green { background: #2ecc71; }
    .seq-btn.blue { background: #3498db; }
    .seq-btn.yellow { background: #f1c40f; }
    .seq-btn:hover { transform: scale(1.1); }
    .seq-btn.flash { opacity: 0.5; }
</style>
{% endblock %}

{% block content %}
<div class="sequence-game">
    <h4 class="text-center mb-3">üéµ –ü–æ–≤—Ç–æ—Ä–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h4>
    <p class="text-center text-muted mb-3" id="status">–°–º–æ—Ç—Ä–∏ –∏ –∑–∞–ø–æ–º–∏–Ω–∞–π!</p>
    <div class="seq-buttons" id="seqButtons">
        <button class="seq-btn red" data-color="red"></button>
        <button class="seq-btn green" data-color="green"></button>
        <button class="seq-btn blue" data-color="blue"></button>
        <button class="seq-btn yellow" data-color="yellow"></button>
    </div>
    <form method="post" id="seqForm" class="mt-3">
        {% csrf_token %}
        <input type="hidden" name="session_id" value="{{ session.id }}">
        <input type="hidden" name="level_reached" id="levelReached" value="1">
        <input type="hidden" name="mistakes" id="mistakes" value="0">
        <button type="submit" class="btn btn-success w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
    </form>
    <a href="{% url 'game_dashboard' child.id %}" class="btn btn-outline-secondary mt-2 w-100">–ù–∞–∑–∞–¥</a>
</div>
<script>
const colors = ['red','green','blue','yellow'];
const NOTES = { red: 261.63, green: 329.63, blue: 392, yellow: 523.25 }; // C4, E4, G4, C5
let sequence = [], level = 1, mistakes = 0, playerTurn = false, playerIdx = 0;

function playNote(freq) {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.2);
    } catch(e) {}
}

function flash(btn, playSound = true) {
    btn.classList.add('flash');
    if (playSound) playNote(NOTES[btn.dataset.color]);
    setTimeout(() => btn.classList.remove('flash'), 300);
}

function addToSequence() {
    sequence.push(colors[Math.floor(Math.random() * 4)]);
}

function playSequence() {
    playerTurn = false;
    playerIdx = 0;
    document.getElementById('status').textContent = '–°–º–æ—Ç—Ä–∏...';
    let i = 0;
    const interval = setInterval(() => {
        const btn = document.querySelector(`[data-color="${sequence[i]}"]`);
        flash(btn, true);
        i++;
        if (i >= sequence.length) {
            clearInterval(interval);
            playerTurn = true;
            document.getElementById('status').textContent = '–¢–≤–æ—è –æ—á–µ—Ä–µ–¥—å!';
        }
    }, 600);
}

document.querySelectorAll('.seq-btn').forEach(btn => {
    btn.onclick = () => {
        if (!playerTurn) return;
        flash(btn, true);
        if (btn.dataset.color !== sequence[playerIdx]) {
            mistakes++;
            document.getElementById('mistakes').value = mistakes;
            document.getElementById('status').textContent = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞';
            document.querySelector('.seq-buttons').style.pointerEvents = 'none';
            return;
        }
        playerIdx++;
        if (playerIdx >= sequence.length) {
            level++;
            document.getElementById('levelReached').value = level;
            addToSequence();
            setTimeout(playSequence, 800);
        }
    };
});

function shuffleEls(container) {
    const arr = Array.from(container.children);
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    arr.forEach(el => container.appendChild(el));
}
shuffleEls(document.getElementById('seqButtons'));
addToSequence();
setTimeout(playSequence, 500);
</script>
{% endblock %}
