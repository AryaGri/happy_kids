{% extends "base.html" %}

{% block content %}
<h1>Игра: Раскраска</h1>

<p>Выберите цвет и рисуйте на холсте!</p>

<!-- Контейнер с холстом -->
<div class="canvas-wrapper" style="display: inline-block;">
<canvas id="paintingCanvas" width="500" height="500" style="border: 1px solid #000; touch-action: none;"></canvas>
</div>

<div>
    <!-- Кнопки для выбора цвета -->
    <button type="button" class="color-button" data-emotion="anger" data-color="красная" style="background-color: red;">Красная</button>
    <button type="button" class="color-button" data-emotion="joy" data-color="оранжевая" style="background-color: orange;">Оранжевая </button>
    <button type="button" class="color-button" data-emotion="joy" data-color="жёлтая" style="background-color: yellow;">Жёлтая </button>
    <button type="button" class="color-button" data-emotion="happiness" data-color="зелёная" style="background-color: green;">Зелёная </button>
    <button type="button" class="color-button" data-emotion="sorrow" data-color="синяя" style="background-color: blue;">Синяя</button>
    <button type="button" class="color-button" data-emotion="love" data-color="фиолетовая" style="background-color: purple;">Фиолетовая</button>
</div>

<form method="post" id="paintingForm" class='form1'>
    {% csrf_token %}
    <input type="hidden" name="session_id" value="{{ session.id }}">
    <input type="hidden" name="drawing_data" id="drawingData" value="">
    <!-- Скрытые поля для передачи баллов на сервер -->
    <input type="hidden" name="anger" id="anger" value="0">
    <input type="hidden" name="joy" id="joy" value="0">
    <input type="hidden" name="sorrow" id="sorrow" value="0">
    <input type="hidden" name="love" id="love" value="0">
    <input type="hidden" name="boredom" id="boredom" value="0">
    <input type="hidden" name="happiness" id="happiness" value="0">
    <button type="submit" class="btn btn-primary mt-3">Сохранить рисунок</button>
    <a href="{% url 'game_dashboard' child.id %}" class="btn btn-secondary mt-3">Назад к дашборду</a>
</form>




<script>
// Инициализация холста
const canvas = document.getElementById('paintingCanvas');
const ctx = canvas.getContext('2d');
let currentColor = 'black';
let painting = false;

// Корректное преобразование координат (учёт масштаба и скролла)
function getCanvasCoords(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const x = (e.clientX - rect.left) * scaleX;
    const y = (e.clientY - rect.top) * scaleY;
    return { x, y };
}

function getTouchCoords(e) {
    const touch = e.touches[0] || e.changedTouches[0];
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
        x: (touch.clientX - rect.left) * scaleX,
        y: (touch.clientY - rect.top) * scaleY
    };
}

function drawAt(x, y) {
    ctx.lineWidth = 5;
    ctx.lineCap = 'round';
    ctx.strokeStyle = currentColor;
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
}

canvas.addEventListener('mousedown', (e) => {
    painting = true;
    const { x, y } = getCanvasCoords(e);
    ctx.beginPath();
    ctx.moveTo(x, y);
    drawAt(x, y);
});

canvas.addEventListener('mouseup', () => {
    painting = false;
    ctx.beginPath();
});

canvas.addEventListener('mouseleave', () => { painting = false; ctx.beginPath(); });

canvas.addEventListener('mousemove', (e) => {
    if (!painting) return;
    const { x, y } = getCanvasCoords(e);
    drawAt(x, y);
});

// Поддержка сенсорных экранов
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    painting = true;
    const { x, y } = getTouchCoords(e);
    ctx.beginPath();
    ctx.moveTo(x, y);
});

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!painting) return;
    const { x, y } = getTouchCoords(e);
    drawAt(x, y);
});

canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    painting = false;
    ctx.beginPath();
});

// Обработка выбора цвета
document.querySelectorAll('.color-button').forEach(button => {
    button.addEventListener('click', function() {
        const emotion = this.getAttribute('data-emotion');  // Эмоция, которая соответствует цвету
        const color = this.getAttribute('data-color');     // Сам цвет

        // Устанавливаем цвет для рисования
        if (color === 'красная') {
            currentColor = 'red';
        } else if (color === 'оранжевая') {
            currentColor = 'orange';
        } else if (color === 'жёлтая') {
            currentColor = 'yellow';
        } else if (color === 'зелёная') {
            currentColor = 'green';
        } else if (color === 'синяя') {
            currentColor = 'blue';
        } else if (color === 'фиолетовая') {
            currentColor = 'purple';
        }

        // Увеличиваем балл для выбранной эмоции
        let currentValue = parseInt(document.getElementById(emotion).value) || 0;
        document.getElementById(emotion).value = currentValue + 1;

    });
});

// Перед отправкой формы — сохраняем рисунок в скрытое поле
document.getElementById('paintingForm').addEventListener('submit', function() {
    const dataUrl = canvas.toDataURL('image/png');
    document.getElementById('drawingData').value = dataUrl;
});
</script>

{% endblock %}
