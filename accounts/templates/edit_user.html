{% extends 'base.html' %}

{% block content %}
  <div class="container">
    <h2>Редактировать пользователя: {{ user.username }}</h2>

    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.GET.next }}">
      <div class="form-group">
        <label for="username">Логин:</label>
        <input type="text" name="username" id="username" class="form-control" value="{{ user.username }}" required>
      </div>

      <div class="form-group">
        <label for="name">ФИО:</label>
        <input type="text" name="name" id="name" class="form-control" value="{{ user.name }}" required>
      </div>

      <div class="form-group">
        <label for="date_of_b">Дата рождения:</label>
        <input type="date" name="date_of_b" id="date_of_b" class="form-control" value="{{ user.date_of_b|date:'Y-m-d' }}" required>

      </div>
      <div class="form-group">
        <label for="password">Пароль:</label>
        <input type="text" name="password" id="password" class="form-control" value="{{ user.password}}" required>
        </div>

      <div class="form-group">
        <label for="role">Роль:</label>
        <select name="role" id="role" class="form-control" required>
          {% if user.role == 'admin' %}<option value="admin" selected>Администратор</option>{% endif %}
          <option value="doctor" {% if user.role == 'doctor' %}selected{% endif %}>Врач</option>
          <option value="parent" {% if user.role == 'parent' %}selected{% endif %}>Родитель</option>
          <option value="child" {% if user.role == 'child' %}selected{% endif %}>Ребёнок</option>
        </select>
        <small class="text-muted">Роль администратора нельзя создать или назначить через интерфейс</small>
      </div>

      {% if user.role == 'child' %}
      <div class="form-group mt-3 p-3 border rounded bg-light">
        <h6 class="mb-2">Привязки ребёнка</h6>
        <p class="text-muted small mb-2">К каким родителям и врачам привязан ребёнок. Чтобы изменить — отредактируйте соответствующего родителя или врача.</p>
        <div class="mb-2">
          <strong>Родители:</strong>
          {% if user.parents.all %}
          <ul class="mb-0 mt-1">
            {% for p in user.parents.all %}
            <li><a href="{% url 'edit_parent' p.id %}">{{ p.name }} ({{ p.username }})</a></li>
            {% endfor %}
          </ul>
          {% else %}
          <span class="text-muted">Не привязан</span>
          {% endif %}
        </div>
        <div>
          <strong>Врачи:</strong>
          {% if user.doctors.all %}
          <ul class="mb-0 mt-1">
            {% for d in user.doctors.all %}
            <li><a href="{% url 'edit_doctor' d.id %}">{{ d.name }} ({{ d.username }})</a></li>
            {% endfor %}
          </ul>
          {% else %}
          <span class="text-muted">Не привязан</span>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <button type="submit" class="btn btn-primary">Сохранить изменения</button>
    </form>

    <div class="mt-3">
        <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">Назад к дашборду</a>
        <a href="{% url 'admin_delete_user' user.id %}" class="btn btn-outline-danger ms-2">Удалить пользователя</a>
    </div>
  </div>
{% endblock %}
